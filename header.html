<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üì¢ ‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ú‡πà‡∏≤‡∏ô LINE</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background: #f7f7f7;
      }
      .news-image {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="text-success mb-4">üì¢ ‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</h1>
      <div id="newsContainer" class="card shadow-sm" style="display: none">
        <img id="newsImage" class="news-image" src="" alt="" />
        <div class="card-body">
          <h5 id="newsTitle" class="fw-bold text-success"></h5>
          <p id="newsContent" class="fs-5"></p>
          <div class="text-muted mt-4" id="newsDate"></div>
          <div class="d-flex justify-content-between mt-3">
            <a
              id="originalLink"
              href="#"
              target="_blank"
              class="btn btn-outline-secondary btn-sm"
              >üîó ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a
            >
            <button id="shareBtn" class="btn btn-outline-danger btn-sm">
              üì§ ‡∏™‡πà‡∏á LINE Flex
            </button>
          </div>
        </div>
      </div>
      <div id="errorMsg" class="text-danger fw-semibold"></div>
      <div id="loadingMsg" class="text-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß...</div>
    </div>

    <!-- Modal Flex -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</strong> <span id="modalTitle"></span></p>
            <p><strong>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤:</strong> <span id="modalContent"></span></p>
            <p><strong>‡∏•‡∏¥‡∏á‡∏Å‡πå:</strong> <span id="modalLink"></span></p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" id="modalSendBtn">
              üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE
            </button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              ‡∏õ‡∏¥‡∏î
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const sheetApiUrl =
        "https://script.google.com/macros/s/AKfycbw7HEHW_mrgBUD-L1ogKs7r6XbbdenH6UwuS6W8XhUVeTeHci0gKW3IAOJ080YMc7PjGw/exec";
      const fallbackImage =
        "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg";

      const urlParams = new URLSearchParams(window.location.search);
      let id = urlParams.get("id");

      // üîÅ Restore from liff.state
      if (!id && urlParams.get("liff.state")) {
        const restoredUrl = new URL(
          "https://dummy.com" + decodeURIComponent(urlParams.get("liff.state"))
        );
        id = restoredUrl.searchParams.get("id");
        if (id) {
          history.replaceState(
            {},
            "",
            `${location.pathname}?id=${encodeURIComponent(id)}`
          );
        }
      }

      async function loadNews() {
        const response = await fetch(
          `${sheetApiUrl}?link=${encodeURIComponent(id)}`
        );
        const data = await response.json();
        document.getElementById("loadingMsg").style.display = "none";
        if (data && data.translated) {
          localStorage.setItem("newsData", JSON.stringify(data));
          document.getElementById("newsContainer").style.display = "block";
          document.getElementById("newsImage").src =
            data.imageUrl || fallbackImage;
          document.getElementById("newsTitle").textContent = data.title;
          document.getElementById("newsContent").textContent = data.translated;
          document.getElementById("newsDate").textContent = `üóì ${data.pubDate}`;
          document.getElementById("originalLink").href = data.link;
        } else {
          document.getElementById("errorMsg").textContent =
            "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
        }
      }

      function showFlexModal() {
        const data = JSON.parse(localStorage.getItem("newsData"));
        if (data) {
          document.getElementById("modalTitle").textContent = data.title;
          document.getElementById("modalContent").textContent = data.translated;
          document.getElementById("modalLink").textContent = data.link;
          new bootstrap.Modal(document.getElementById("shareModal")).show();
        }
      }

      async function initLiffAndShare() {
        await liff.init({ liffId: "1661018679-NKQMK66O" });
        if (!liff.isLoggedIn()) {
          localStorage.setItem("showModalAfterLogin", "1");
          liff.login({ redirectUri: window.location.href });
        } else {
          if (localStorage.getItem("showModalAfterLogin") === "1") {
            localStorage.removeItem("showModalAfterLogin");
            showFlexModal();
          }
        }
      }

      document
        .getElementById("shareBtn")
        .addEventListener("click", async () => {
          localStorage.setItem("showModalAfterLogin", "1");
          await initLiffAndShare();
        });

      document
        .getElementById("modalSendBtn")
        .addEventListener("click", async () => {
          const data = JSON.parse(localStorage.getItem("newsData"));
          const flexMessage = {
            type: "flex",
            altText: data.title,
            contents: {
              type: "bubble",
              hero: {
                type: "image",
                url: data.imageUrl || fallbackImage,
                size: "full",
                aspectRatio: "16:9",
                aspectMode: "cover",
              },
              body: {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: data.title,
                    weight: "bold",
                    wrap: true,
                  },
                  {
                    type: "text",
                    text: data.translated,
                    wrap: true,
                    margin: "md",
                  },
                ],
              },
              footer: {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "button",
                    action: {
                      type: "uri",
                      label: "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö",
                      uri: data.link,
                    },
                    style: "link",
                  },
                ],
              },
            },
          };
          await liff.shareTargetPicker([flexMessage]);
        });

      // üîÅ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
      if (id) {
        loadNews().then(() => {
          initLiffAndShare();
        });
      } else {
        document.getElementById("errorMsg").textContent =
          "‚ùó ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏ô URL";
        document.getElementById("loadingMsg").style.display = "none";
      }
    </script>
  </body>
</html>
