<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>ðŸ“¢ à¸­à¹ˆà¸²à¸™à¸‚à¹ˆà¸²à¸§à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style-theme.css" />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <style>
      .news-image {
        width: 100%;
        height: auto;
        max-height: 300px;
        object-fit: cover;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div id="header-container"></div>
    <div class="container py-4">
      <h1 class="text-success mb-4">ðŸ“¢ à¸­à¹ˆà¸²à¸™à¸‚à¹ˆà¸²à¸§à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</h1>
      <div id="newsContainer" class="card shadow-sm" style="display: none">
        <img id="newsImage" class="news-image" src="" alt="" />
        <div class="card-body">
          <h5 id="newsTitle" class="fw-bold text-success"></h5>
          <p id="newsContent" class="fs-5"></p>
          <div class="text-muted mt-4" id="newsDate"></div>
          <div class="d-flex justify-content-between mt-3">
            <a
              id="originalLink"
              href="#"
              target="_blank"
              class="btn btn-outline-secondary btn-sm"
              >ðŸ”— à¸­à¹ˆà¸²à¸™à¸•à¹‰à¸™à¸‰à¸šà¸±à¸š</a
            >
            <button id="shareBtn" class="btn btn-outline-danger btn-sm">
              ðŸ“¤ à¸ªà¹ˆà¸‡ LINE Flex
            </button>
          </div>
        </div>
      </div>
      <div id="errorMsg" class="text-danger fw-semibold"></div>
    </div>

    <script>
      dayjs.locale("th");
      dayjs.extend(dayjs_plugin_relativeTime);
      dayjs.extend(dayjs_plugin_utc);
      dayjs.extend(dayjs_plugin_timezone);

      const sheetApiUrl =
        "https://script.google.com/macros/s/AKfycbw7HEHW_mrgBUD-L1ogKs7r6XbbdenH6UwuS6W8XhUVeTeHci0gKW3IAOJ080YMc7PjGw/exec";
      const fallbackImage =
        "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg";
      const params = new URLSearchParams(window.location.search);
      const id = decodeURIComponent(params.get("id"));
      let data = {};

      async function initLiff() {
        await liff.init({ liffId: "1661018679-NKQMK66O" });
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
        }
      }

      function formatSmartThaiDate(isoDate) {
        const now = dayjs().tz("Asia/Bangkok");
        const date = dayjs(isoDate).tz("Asia/Bangkok");
        if (now.isSame(date, "day"))
          return `à¸§à¸±à¸™à¸™à¸µà¹‰ à¹€à¸§à¸¥à¸² ${date.format("HH:mm")} à¸™.`;
        if (now.subtract(1, "day").isSame(date, "day"))
          return `à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™ à¹€à¸§à¸¥à¸² ${date.format("HH:mm")} à¸™.`;
        return date.format("D MMMM YYYY à¹€à¸§à¸¥à¸² HH:mm à¸™.");
      }

      if (id) {
        fetch(`${sheetApiUrl}?link=${encodeURIComponent(id)}`)
          .then((res) => res.json())
          .then((response) => {
            if (response && response.translated) {
              data = response;
              const imageUrl = data.imageUrl || fallbackImage;
              document.getElementById("newsContainer").style.display = "block";
              document.getElementById("newsImage").src = imageUrl;
              document.getElementById("newsTitle").textContent = data.title;
              document.getElementById("newsContent").textContent =
                data.translated;
              document.getElementById(
                "newsDate"
              ).textContent = `ðŸ—“ ${formatSmartThaiDate(data.pubDate)}`;
              document.getElementById("originalLink").href = data.link;
            } else {
              document.getElementById("errorMsg").textContent =
                "âŒ à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹ˆà¸²à¸§à¸™à¸µà¹‰à¹ƒà¸™à¸£à¸°à¸šà¸š";
            }
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("errorMsg").textContent =
              "âš ï¸ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹ˆà¸²à¸§";
          });
      } else {
        document.getElementById("errorMsg").textContent =
          "â— à¹„à¸¡à¹ˆà¸¡à¸µà¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¸‚à¹ˆà¸²à¸§à¹ƒà¸™ URL";
      }

      document
        .getElementById("shareBtn")
        .addEventListener("click", async () => {
          console.log("ðŸ”˜ à¸à¸”à¸›à¸¸à¹ˆà¸¡à¹à¸Šà¸£à¹Œà¹à¸¥à¹‰à¸§");
          try {
            await initLiff();
            console.log("âœ… LIFF init à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");

            if (liff.isApiAvailable("shareTargetPicker")) {
              console.log("âœ… shareTargetPicker à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰");

              const flexMessage = {
                type: "flex",
                altText: data.title,
                contents: {
                  type: "bubble",
                  hero: {
                    type: "image",
                    url: data.imageUrl || fallbackImage,
                    size: "full",
                    aspectRatio: "16:9",
                    aspectMode: "cover",
                  },
                  body: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                      {
                        type: "text",
                        text: data.title,
                        weight: "bold",
                        wrap: true,
                      },
                      {
                        type: "text",
                        text: data.translated,
                        wrap: true,
                        margin: "md",
                      },
                    ],
                  },
                  footer: {
                    type: "box",
                    layout: "horizontal",
                    contents: [
                      {
                        type: "button",
                        action: {
                          type: "uri",
                          label: "à¸­à¹ˆà¸²à¸™à¸•à¹‰à¸™à¸‰à¸šà¸±à¸š",
                          uri: data.link,
                        },
                        style: "link",
                      },
                    ],
                  },
                },
              };

              await liff.shareTargetPicker([flexMessage]);
              console.log("ðŸ“¤ à¹à¸Šà¸£à¹Œ Flex Message à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
            } else {
              console.warn("âš ï¸ shareTargetPicker à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸šà¸™à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸™à¸µà¹‰");
            }
          } catch (err) {
            console.error("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”:", err);
          }
        });

      fetch("header.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("header-container").innerHTML = html;
          const currentTheme = localStorage.getItem("theme") || "light";
          document.body.classList.add(currentTheme);
          const themeSwitcher = document.getElementById("themeSwitcher");
          if (themeSwitcher) {
            themeSwitcher.value = currentTheme;
            themeSwitcher.addEventListener("change", (e) => {
              document.body.className = e.target.value;
              localStorage.setItem("theme", e.target.value);
            });
          }
        });
    </script>
  </body>
</html>
