<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ö‡∏∏‡∏ç‡∏ú‡πà‡∏≤‡∏ô LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f7f7f7;
        margin: 0;
        padding: 20px 0;
        display: flex;
        justify-content: center;
      }
      .content-wrapper {
        width: min(90vw, calc(100vh * (16 / 9)));
        margin: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .btn-full {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        margin-bottom: 15px;
      }
      #previewCardContainer {
        width: 100%;
        margin-bottom: 10px;
      }
      .card-img-top {
        max-height: 250px;
        object-fit: cover;
        transition: max-height 0.3s;
      }
      .version-footer {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
      }
      .version-footer a {
        color: #007bff;
        text-decoration: none;
      }
      .version-footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="content-wrapper">
      <h1>‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ö‡∏∏‡∏ç‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h1>

      <!-- Card Preview -->
      <div id="previewCardContainer"></div>

      <!-- Toggle Button for Full Image -->
      <button id="toggleImageSize" class="btn btn-secondary btn-full">
        ‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
      </button>

      <button id="shareButton" class="btn btn-success btn-full">
        üì§ ‡πÅ‡∏ä‡∏£‡πå Flex Message
      </button>

      <button id="testLogButton" class="btn btn-outline-primary btn-full">
        üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á Flex)
      </button>

      <!-- Footer for webhook version & credit -->
      <div id="footerVersion" class="version-footer"></div>
      <div class="version-footer">
        Developed by
        <a href="https://facebook.com/niyatajayo" target="_blank"
          >@niyatajayo</a
        >
      </div>
    </div>

    <script>
      const webhookUrl =
        "https://script.google.com/macros/s/AKfycbxCkj-3cM9tSU_IWosWOlGX3FZJqojmRxz3h_hyoqCP0n62k_1_pjhr1BZwis_2zW5L/exec";
      const flexMessage = {
        /* ... existing JSON ... */
      };

      function renderPreview(msg) {
        const container = document.getElementById("previewCardContainer");
        const heroUrl = msg.contents.hero.url;
        const title1 = msg.contents.body.contents[0].text;
        const title2 = msg.contents.body.contents[1].text;
        const infoItems = msg.contents.body.contents[2].contents
          .map(
            (item) =>
              `<li class=\"list-group-item\">${item.contents[0].text} ${item.contents[1].text}</li>`
          )
          .join("");
        container.innerHTML = `
          <div class=\"card mb-3\">
            <img src=\"${heroUrl}\" class=\"card-img-top\" alt=\"hero\" />
            <div class=\"card-body\">
              <h5 class=\"card-title\">${title1}</h5>
              <h6 class=\"card-subtitle mb-2 text-muted\">${title2}</h6>
            </div>
            <ul class=\"list-group list-group-flush\">
              ${infoItems}
            </ul>
          </div>
        `;
      }

      async function fetchVersion() {
        try {
          const res = await fetch(webhookUrl);
          if (res.ok) {
            const data = await res.json();
            document.getElementById(
              "footerVersion"
            ).innerText = `Webhook version: ${data.version}`;
          }
        } catch (e) {
          console.error("Error fetching version:", e);
        }
      }

      async function logShareToSheet(status) {
        try {
          const profile = await liff.getProfile();
          await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              status,
              displayName: profile.displayName,
              userId: profile.userId,
              pictureUrl: profile.pictureUrl,
            }),
          });
        } catch (e) {
          console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log:", e);
        }
      }

      async function main() {
        await liff.init({ liffId: "1661018679-Y47yR00l" });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        await liff.ready;

        renderPreview(flexMessage);
        fetchVersion();

        // Toggle image size
        let limited = true;
        document
          .getElementById("toggleImageSize")
          .addEventListener("click", () => {
            const img = document.querySelector(
              "#previewCardContainer .card-img-top"
            );
            if (!img) return;
            limited = !limited;
            img.style.maxHeight = limited ? "250px" : "none";
            img.style.objectFit = limited ? "cover" : "";
            document.getElementById("toggleImageSize").innerText = limited
              ? "‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô"
              : "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á 250px";
          });

        document.getElementById("shareButton").onclick = async () => {
          try {
            const result = await liff.shareTargetPicker([flexMessage]);
            await logShareToSheet(result ? "‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
          } catch {
            await logShareToSheet("‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          } finally {
            setTimeout(() => liff.closeWindow(), 1500);
          }
        };

        document.getElementById("testLogButton").onclick = async () => {
          await logShareToSheet("üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log");
          alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet ‡πÅ‡∏•‡πâ‡∏ß");
        };
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
  </body>
</html>
