<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ö‡∏∏‡∏ç‡∏ú‡πà‡∏≤‡∏ô LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f7f7f7;
        margin: 0;
        padding: 20px 0;
        text-align: center;
        display: flex;
        justify-content: center;
      }
      .content-wrapper {
        /* ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 90vw ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô 16:9 ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á viewport */
        width: min(90vw, calc(100vh * (16 / 9)));
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .btn-full {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        margin-bottom: 15px;
      }
      #previewCardContainer {
        width: 100%;
        margin-bottom: 20px;
      }
      .card-img-top {
        max-height: 250px;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <div class="content-wrapper">
      <h1>‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ö‡∏∏‡∏ç‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h1>

      <!-- Card Preview -->
      <div id="previewCardContainer"></div>

      <button id="shareButton" class="btn btn-success btn-full">
        üì§ ‡πÅ‡∏ä‡∏£‡πå Flex Message
      </button>

      <button id="testLogButton" class="btn btn-outline-primary btn-full">
        üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á Flex)
      </button>
    </div>

    <script>
      const webhookUrl =
        "https://script.google.com/macros/s/AKfycbxCkj-3cM9tSU_IWosWOlGX3FZJqojmRxz3h_hyoqCP0n62k_1_pjhr1BZwis_2zW5L/exec";

      const flexMessage = {
        /* ... JSON as before ... */ contents: {
          /* ... */
        },
      };

      function renderPreview(msg) {
        const container = document.getElementById("previewCardContainer");
        const heroUrl = msg.contents.hero.url;
        const title1 = msg.contents.body.contents[0].text;
        const title2 = msg.contents.body.contents[1].text;
        const infoItems = msg.contents.body.contents[2].contents
          .map(
            (item) =>
              `<li class="list-group-item">${item.contents[0].text} ${item.contents[1].text}</li>`
          )
          .join("");

        container.innerHTML = `
          <div class="card mb-3">
            <img src="${heroUrl}" class="card-img-top" alt="hero" />
            <div class="card-body">
              <h5 class="card-title">${title1}</h5>
              <h6 class="card-subtitle mb-2 text-muted">${title2}</h6>
            </div>
            <ul class="list-group list-group-flush">
              ${infoItems}
            </ul>
          </div>
        `;
      }

      async function logShareToSheet(status) {
        try {
          const profile = await liff.getProfile();
          await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              status,
              displayName: profile.displayName,
              userId: profile.userId,
              pictureUrl: profile.pictureUrl,
            }),
          });
        } catch (e) {
          console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log:", e);
        }
      }

      async function main() {
        await liff.init({ liffId: "1661018679-Y47yR00l" });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        await liff.ready;
        renderPreview(flexMessage);

        document.getElementById("shareButton").onclick = async () => {
          try {
            const result = await liff.shareTargetPicker([flexMessage]);
            await logShareToSheet(result ? "success" : "cancel");
          } catch {
            await logShareToSheet("error");
          } finally {
            setTimeout(() => liff.closeWindow(), 1500);
          }
        };

        document.getElementById("testLogButton").onclick = async () => {
          await logShareToSheet("test");
          alert("‡∏™‡πà‡∏á log ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
        };
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
  </body>
</html>
