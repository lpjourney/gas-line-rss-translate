
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏™‡πà‡∏á Carousel Flex ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background: #f7f7f7; padding: 20px; font-family: sans-serif; }
    .card { margin-bottom: 15px; }
    .btn-success { width: 100%; }
    .preview-img { max-height: 150px; object-fit: cover; }
  </style>
</head>
<body>
  <h4>üì¢ <span class="text-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß</span> ‚Üí <span class="text-success">‡∏™‡πà‡∏á Flex ‡πÅ‡∏ö‡∏ö Carousel</span></h4>
  <div id="newsList" class="my-3">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß...</div>
  <button id="sendBtn" class="btn btn-success">üöÄ ‡∏™‡πà‡∏á Carousel Flex</button>
  <div id="result" class="mt-3 text-danger fw-bold"></div>

  <script>
    const DEFAULT_IMG = "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg";
    const API_URL = "https://script.google.com/macros/s/AKfycbw7HEHW_mrgBUD-L1ogKs7r6XbbdenH6UwuS6W8XhUVeTeHci0gKW3IAOJ080YMc7PjGw/exec?preview=1";

    let allNews = [];

    async function loadNews() {
      try {
        const res = await fetch(API_URL);
        allNews = await res.json();

        const listEl = document.getElementById("newsList");
        listEl.innerHTML = "";

        allNews.forEach((n, i) => {
          const imgUrl = n.image?.startsWith("http") ? n.image : DEFAULT_IMG;
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="card-body">
              <input type="checkbox" class="form-check-input me-2" data-index="${i}" checked>
              <strong>${n.title}</strong>
              <p class="mb-1">${n.translated}</p>
              <img src="${imgUrl}" onerror="this.src='${DEFAULT_IMG}'" class="preview-img w-100 rounded" />
            </div>
          `;
          listEl.appendChild(card);
        });
      } catch (err) {
        document.getElementById("newsList").innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        console.error(err);
      }
    }

    async function sendCarousel() {
      try {
        await liff.init({ liffId: "1661018679-erv7N44z" });
        if (!liff.isInClient()) throw new Error("‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE");

        const checked = [...document.querySelectorAll("input[type=checkbox]:checked")];
        if (checked.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

        const contents = checked.slice(0, 10).map(c => {
          const item = allNews[c.dataset.index];
          const imgUrl = item.image?.startsWith("http") ? item.image : DEFAULT_IMG;

          return {
            type: "bubble",
            hero: {
              type: "image",
              url: imgUrl,
              size: "full",
              aspectRatio: "16:9",
              aspectMode: "cover"
            },
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                { type: "text", text: item.title, weight: "bold", wrap: true },
                { type: "text", text: item.translated.substring(0, 450), size: "sm", wrap: true }
              ]
            },
            footer: {
              type: "box",
              layout: "horizontal",
              contents: [
                {
                  type: "button",
                  style: "primary",
                  action: {
                    type: "uri",
                    label: "üìñ ‡∏≠‡πà‡∏≤‡∏ô",
                    uri: "https://news.watsaitama.com/liff-news.html?id=" + encodeURIComponent(item.link)
                  }
                }
              ]
            }
          };
        });

        await liff.sendMessages([
          {
            type: "flex",
            altText: "üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
            contents: {
              type: "carousel",
              contents
            }
          }
        ]);

        document.getElementById("result").innerHTML = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
        liff.closeWindow(); // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
      }
    }

    document.getElementById("sendBtn").onclick = sendCarousel;
    loadNews();
  </script>
</body>
</html>
