<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>üì¢ ‡∏™‡πà‡∏á Carousel Flex ‡∏ú‡πà‡∏≤‡∏ô LIFF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: auto;
      }
      .news-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        background: #f9f9f9;
      }
      .news-item input {
        margin-right: 10px;
      }
      .news-item img {
        max-width: 100%;
        border-radius: 4px;
        margin-top: 5px;
      }
      button {
        margin-top: 20px;
        padding: 12px;
        font-size: 1rem;
        width: 100%;
      }
      #status {
        margin-top: 15px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>üì¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß ‚Üí ‡∏™‡πà‡∏á Carousel Flex ‡∏ú‡πà‡∏≤‡∏ô LIFF</h2>
    <div id="newsList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß...</div>
    <button onclick="sendCarousel()">üöÄ ‡∏™‡πà‡∏á Carousel Flex</button>
    <div id="status"></div>

    <script>
      const api = "https://script.google.com/macros/s/AKfycbzIeh-8ONQAbklb1yYDlOpiME28qL44LFeySxiRIrY6Py5YFEwCPeYhqYM3QujdShYbYw/exec";
      let newsData = [];

      async function fetchNews() {
        const res = await fetch(api + "?preview=1");
        newsData = await res.json();
        const container = document.getElementById("newsList");
        container.innerHTML = "";

        newsData.forEach((item, i) => {
          const box = document.createElement("div");
          box.className = "news-item";
          box.innerHTML = \`
            <label>
              <input type="checkbox" value="\${i}">
              <strong>\${item.title}</strong><br>
              <small>\${item.translated.slice(0, 100)}...</small><br>
              <img src="\${item.image || 'https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg'}">
            </label>
          \`;
          container.appendChild(box);
        });
      }

      async function sendCarousel() {
        const selected = [...document.querySelectorAll("input[type='checkbox']:checked")].map(c => newsData[c.value]);

        if (selected.length === 0) {
          document.getElementById("status").textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πà‡∏≤‡∏ß";
          return;
        }

        const bubbles = selected.slice(0, 10).map(item => ({
          type: "bubble",
          hero: {
            type: "image",
            url: item.image || "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg",
            size: "full",
            aspectRatio: "16:9",
            aspectMode: "cover"
          },
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              { type: "text", text: item.title, weight: "bold", size: "md", wrap: true },
              { type: "text", text: item.translated.slice(0, 450), size: "sm", wrap: true, margin: "md" }
            ]
          },
          footer: {
            type: "box",
            layout: "horizontal",
            contents: [
              {
                type: "button",
                style: "primary",
                height: "sm",
                action: {
                  type: "uri",
                  label: "üìñ ‡∏≠‡πà‡∏≤‡∏ô",
                  uri: "https://news.watsaitama.com/liff-news.html?id=" + encodeURIComponent(item.link)
                }
              }
            ]
          }
        }));

        const carouselFlex = {
          type: "flex",
          altText: "üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠",
          contents: {
            type: "carousel",
            contents: bubbles
          }
        };

        try {
          await liff.init({ liffId: "1661018679-erv7N44z" });
          await liff.sendMessages([carouselFlex]);
          document.getElementById("status").textContent = "‚úÖ ‡∏™‡πà‡∏á Carousel Flex ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
          liff.closeWindow();
        } catch (err) {
          console.error(err);
          document.getElementById("status").textContent = "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        }
      }

      fetchNews();
    </script>
  </body>
</html>
