<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏™‡πà‡∏á Carousel Flex ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        background: #f7f7f7;
        padding: 20px;
        font-family: sans-serif;
      }
      .card {
        margin-bottom: 15px;
      }
      .btn-success {
        width: 100%;
      }
      .preview-img {
        max-height: 200px;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏ô‡∏π -->
    <div id="header-container"></div>

    <h4>
      üì¢ <span class="text-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß</span> ‚Üí
      <span class="text-success">‡∏™‡πà‡∏á Flex ‡πÅ‡∏ö‡∏ö Carousel</span>
    </h4>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞ pagination controls -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button id="clearBtn" class="btn btn-outline-secondary">
        ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      </button>
      <nav aria-label="Page navigation">
        <ul class="pagination mb-0" id="pagination"></ul>
      </nav>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß -->
    <div id="newsList" class="row g-3"></div>

    <button id="sendBtn" class="btn btn-success mt-3">
      üöÄ ‡∏™‡πà‡∏á Carousel Flex
    </button>
    <div id="result" class="mt-3 text-danger fw-bold"></div>

    <script>
      // ‡∏î‡∏∂‡∏á header.html ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
      fetch("header.html")
        .then((res) => res.text())
        .then(
          (html) =>
            (document.getElementById("header-container").innerHTML = html)
        )
        .catch((err) => console.error("‡πÇ‡∏´‡∏•‡∏î header ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err));

      const DEFAULT_IMG =
        "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg";
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwvZ99tMiJmnyTrkIIXbOiCyTEZDfmXvPW19Gvo7LEXzJx1w7AOOYhvAdlcQvgTn32pPg/exec?preview=1";

      let allNews = [];
      let currentPage = 1;
      const pageSize = 10;

      async function loadNews() {
        try {
          const res = await fetch(API_URL);
          allNews = await res.json();
          renderPagination();
          renderPage(1);
        } catch (err) {
          document.getElementById("newsList").innerHTML =
            "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
          console.error(err);
        }
      }

      function renderPage(page) {
        currentPage = page;
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        const slice = allNews.slice(start, end);

        const listEl = document.getElementById("newsList");
        listEl.innerHTML = "";

        slice.forEach((n, i) => {
          const idx = start + i;
          const imgUrl = n.image?.startsWith("http") ? n.image : DEFAULT_IMG;

          const col = document.createElement("div");
          col.className = "col-12 col-md-6";

          const card = document.createElement("div");
          card.className = "card h-100";
          card.innerHTML = `
            <div class="card-body d-flex flex-column">
              <div class="mb-2">
                <input type="checkbox" class="form-check-input me-2" data-index="${idx}" checked>
                <strong>${n.title}</strong>
              </div>
              <p class="mb-2 flex-grow-1">${n.translated}</p>
              <img
                src="${imgUrl}"
                onerror="this.src='${DEFAULT_IMG}'"
                class="preview-img w-100 rounded mb-2"
              />
              <small class="text-muted">${new Date(
                n.pubDate || n.date || Date.now()
              ).toLocaleDateString()}</small>
            </div>
          `;

          col.appendChild(card);
          listEl.appendChild(col);
        });

        updatePaginationUI();
      }

      function renderPagination() {
        const totalPages = Math.ceil(allNews.length / pageSize);
        const pagEl = document.getElementById("pagination");
        pagEl.innerHTML = "";

        for (let p = 1; p <= totalPages; p++) {
          const li = document.createElement("li");
          li.className = "page-item" + (p === currentPage ? " active" : "");
          li.innerHTML = `<a class="page-link" href="#">${p}</a>`;
          li.onclick = (e) => {
            e.preventDefault();
            renderPage(p);
          };
          pagEl.appendChild(li);
        }
      }

      function updatePaginationUI() {
        const items = document.querySelectorAll("#pagination .page-item");
        items.forEach((li, idx) => {
          li.classList.toggle("active", idx + 1 === currentPage);
        });
      }

      function clearSelections() {
        document
          .querySelectorAll("input[type=checkbox]")
          .forEach((chk) => (chk.checked = false));
      }

      async function sendCarousel() {
        try {
          await liff.init({ liffId: "1661018679-erv7N44z" });
          if (!liff.isInClient()) throw new Error("‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE");

          const checked = [
            ...document.querySelectorAll("input[type=checkbox]:checked"),
          ];
          if (checked.length === 0)
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

          const contents = checked.slice(0, 10).map((c) => {
            const item = allNews[c.dataset.index];
            const imgUrl = item.image?.startsWith("http")
              ? item.image
              : DEFAULT_IMG;

            return {
              type: "bubble",
              hero: {
                type: "image",
                url: imgUrl,
                size: "full",
                aspectRatio: "16:9",
                aspectMode: "cover",
              },
              body: {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: item.title,
                    weight: "bold",
                    wrap: true,
                  },
                  {
                    type: "text",
                    text: item.translated.substring(0, 450),
                    size: "sm",
                    wrap: true,
                  },
                ],
              },
              footer: {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    style: "primary",
                    type: "button",
                    action: {
                      type: "uri",
                      label: "üìñ ‡∏≠‡πà‡∏≤‡∏ô",
                      uri:
                        "https://news.watsaitama.com/liff-news.html?id=" +
                        encodeURIComponent(item.link),
                    },
                  },
                ],
              },
            };
          });

          await liff.sendMessages([
            {
              type: "flex",
              altText: "üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
              contents: { type: "carousel", contents },
            },
          ]);

          document.getElementById("result").innerHTML = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
          liff.closeWindow();
        } catch (err) {
          console.error(err);
          document.getElementById("result").innerText =
            "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        }
      }

      // ‡∏ú‡∏π‡∏Å event listeners
      document.getElementById("sendBtn").onclick = sendCarousel;
      document.getElementById("clearBtn").onclick = clearSelections;

      loadNews();
    </script>
  </body>
</html>
