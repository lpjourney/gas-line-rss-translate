<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>üì¢ ‡∏™‡πà‡∏á Flex ‡∏ú‡πà‡∏≤‡∏ô LIFF ID</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 700px;
        margin: auto;
      }
      select,
      button {
        padding: 10px;
        font-size: 1rem;
        width: 100%;
        margin-top: 10px;
      }
      .card-preview {
        margin-top: 20px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #f9f9f9;
        padding: 15px;
      }
      .card-preview img {
        max-width: 100%;
        border-radius: 6px;
        margin-bottom: 10px;
      }
      .flex-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 5px;
      }
      .flex-content {
        font-size: 0.95rem;
        color: #333;
      }
      #status {
        margin-top: 20px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>üì¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á Flex ‡∏ú‡πà‡∏≤‡∏ô LIFF</h2>

    <select id="newsSelect">
      <option disabled selected>üîç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß...</option>
    </select>

    <div class="card-preview" id="previewBox" style="display: none">
      <img id="previewImage" src="" alt="Preview Image" />
      <div class="flex-title" id="previewTitle"></div>
      <div class="flex-content" id="previewContent"></div>
      <button disabled>üìé ‡∏õ‡∏∏‡πà‡∏° Flex (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
    </div>

    <button onclick="sendViaLIFF()" id="sendBtn" style="display: none">
      üöÄ ‡∏™‡πà‡∏á Flex ‡∏ú‡πà‡∏≤‡∏ô LIFF
    </button>

    <div id="status"></div>

    <script>
      const api =
        "https://script.google.com/macros/s/AKfycbzIeh-8ONQAbklb1yYDlOpiME28qL44LFeySxiRIrY6Py5YFEwCPeYhqYM3QujdShYbYw/exec";
      let newsData = [];

      // helper ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤
      function getRelativeTime(dateObj) {
        const now = new Date();
        const diffMs = now - dateObj;
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffHours < 1) return "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
        if (diffHours < 24) return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        if (diffDays === 1) return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô";
        return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      }

      async function fetchNews() {
        const res = await fetch(api + "?preview=1");
        newsData = await res.json();
        const now = new Date();

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á flags ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà (<24 ‡∏ä‡∏°.)
        let isNew = newsData.map((item) => {
          const d = new Date(item.pubDate); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô property ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
          return now - d < 24 * 3600000;
        });
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà < 3 ‡∏ä‡∏¥‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÉ‡∏´‡πâ 3 ‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
        if (isNew.filter((f) => f).length < 3) {
          for (let i = 0; i < 3 && i < isNew.length; i++) isNew[i] = true;
        }

        const sel = document.getElementById("newsSelect");
        newsData.forEach((item, index) => {
          const dateObj = new Date(item.pubDate);
          const timeLabel = getRelativeTime(dateObj);
          const formattedDate = dateObj.toLocaleDateString("th-TH", {
            day: "numeric",
            month: "short",
            year: "numeric",
          });
          const icon = isNew[index] ? "üÜï" : "üìÑ";

          const option = document.createElement("option");
          option.value = index;
          option.textContent = `${icon} [${timeLabel}] ${formattedDate} ${item.title}`;
          sel.appendChild(option);
        });

        sel.onchange = function () {
          const i = parseInt(this.value);
          const item = newsData[i];
          document.getElementById("previewTitle").textContent = item.title;
          document.getElementById("previewContent").textContent =
            item.translated;
          document.getElementById("previewImage").src =
            item.image ||
            "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg";
          document.getElementById("previewBox").style.display = "block";
          document.getElementById("sendBtn").style.display = "block";
        };
      }

      async function sendViaLIFF() {
        const i = document.getElementById("newsSelect").value;
        const item = newsData[i];

        const flexMsg = {
          type: "flex",
          altText: "üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠",
          contents: {
            type: "bubble",
            hero: {
              type: "image",
              url:
                item.image ||
                "https://png.pngtree.com/thumb_back/fh260/background/20231108/pngtree-japanese-style-2024-year-of-the-dragon-new-year-background-image_13958021.jpg",
              size: "full",
              aspectRatio: "16:9",
              aspectMode: "cover",
            },
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: item.title,
                  weight: "bold",
                  size: "lg",
                  wrap: true,
                },
                {
                  type: "text",
                  text: item.translated.slice(0, 450),
                  size: "sm",
                  wrap: true,
                  margin: "md",
                },
              ],
            },
            footer: {
              type: "box",
              layout: "horizontal",
              contents: [
                {
                  type: "button",
                  style: "primary",
                  height: "sm",
                  action: {
                    type: "uri",
                    label: "üìñ ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
                    uri:
                      "https://news.watsaitama.com/liff-news.html?id=" +
                      encodeURIComponent(item.link),
                  },
                },
                {
                  type: "button",
                  style: "secondary",
                  height: "sm",
                  action: {
                    type: "uri",
                    label: "üîó ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö",
                    uri: item.link,
                  },
                },
              ],
            },
          },
        };

        try {
          await liff.init({ liffId: "1661018679-7JYB8QQ1" });
          await liff.sendMessages([flexMsg]);
          document.getElementById("status").textContent =
            "‚úÖ ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô LIFF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
          liff.closeWindow();
        } catch (err) {
          console.error(err);
          document.getElementById("status").textContent =
            "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        }
      }

      fetchNews();
    </script>
  </body>
</html>
